* Abaqus-Like UI Refactor Plan
** Status
   - Overall: In Progress
   - Last Update: 2026-02-24

** Goals
   - Provide an Abaqus-like user experience for model setup, solve, and post-processing.
   - Make the app look and feel like a professional simulation suite.
   - Keep the workflow end-to-end: geometry -> mesh -> solve -> results.

** Plan
*** DONE 1. 信息架构与流程定义
    - Abaqus-style Model Tree:
      Parts / Materials / Sections / Steps / BC / Loads / Interactions / Mesh / Jobs / Results
    - Shortest demo workflow:
      Part -> Material -> Section -> Assembly -> Step -> BC/Load -> Mesh -> Job -> Results
    - UI wireframe + view list:
      +---------------------------------------------------------------+
      | Menu/Toolbar                                                  |
      +---------------------------------------------------------------+
      | Modules: Part | Property | Assembly | Step | Interaction |    |
      |          Load | Mesh | Job | Visualization                    |
      +--------------------+----------------------+-------------------+
      | Model Tree         |   Viewport (VTK)     | Property Editor   |
      | Parts              |   + 2D/Plot/Table    | Context-sensitive |
      | Materials          |                      | forms             |
      | Sections           |                      |                   |
      | Steps              |                      |                   |
      | BC / Loads         |                      |                   |
      | Interactions       |                      |                   |
      | Mesh               |                      |                   |
      | Jobs               |                      |                   |
      | Results            |                      |                   |
      +--------------------+----------------------+-------------------+
      | Job/Message Console (run log, warnings, progress)             |
      +---------------------------------------------------------------+

*** DONE 2. Qt 界面框架搭建
    - Top module tabs: Part / Property / Assembly / Step / Interaction / Load / Mesh / Job / Visualization
    - Left: Model Tree
    - Right: Property Editor
    - Center: Multi-view (VTK + 2D/Plot/Table)
    - Bottom: Job/Message console

*** DONE 3. 数据模型与项目结构
    - Project file format (JSON/YAML)
    - CRUD for model tree nodes
    - Property panel binding
    - Import/export project

*** DONE 4. 仿真流程打通
    - [X] Gmsh: geometry/mesh import or generate
    - [X] MOOSE: parameterized templates and input generation
    - [X] Jobs: unified run management + logs
    - [X] Results: auto load .e + scalar/component selection + time steps
    - [X] Model Tree: mesh/job/result 节点自动同步
    - [X] Model Tree -> MOOSE 输入块联动 (BC/Load/Material/Step)
    - [X] Model Tree -> MOOSE 输入块联动 (Functions/Variables/Outputs)
    - [X] Mesh preview in VTK (direct .msh)

*** TODO 5. 视觉与交互拟真
    - [X] Toolbar + status bar
    - [X] Model Tree icons + context menu
    - [X] Base theme (colors, borders)
    - [X] Shortcuts + status notifications
    - [X] Refined spacing and typography
    - [X] Consistent button sizing
    - [X] Dark-on-gray icon set

*** TODO 6. 展示与案例
    - [X] 2 representative cases wired to Model Tree + MOOSE sync
    - [X] One-click run demo (Menu: Demos -> Run ...)
    - [X] Add third case (nonlinear heat)
    - [X] Screenshots (Save Screenshot...)
    - [ ] Recording

** Progress Update (2026-02-20)
   - UI: Added toolbar, status bar, shortcuts, and base theme.
   - Model Tree: CRUD + YAML save/load + auto sync to MOOSE blocks.
   - Workflow: Mesh/Job/Result nodes auto-populated; results auto-loaded.
   - Remaining: refine typography/spacing; expand MOOSE mapping; add demo cases.

* Gmsh Capability Expansion Plan (libgmsh-only)
** Goals
   - Move from “sample box mesh” to a usable Gmsh-like modeling + meshing workflow.
   - Support CAD/geo import, entity inspection, physical groups, size fields, and mesh controls.
   - Keep everything non-interactive (no embedded Gmsh GUI), but expose core operations.

** Plan
*** TODO 1. Geometry IO + Session Controls
    - [X] Add “Open Geometry” (STEP/IGES/BREP/Geo) to Gmsh panel.
    - [X] Add “Reset/Clear Model” action (gmsh::clear).
    - [X] Track current geometry source path in UI.
    - [X] Entity summary (counts for points/curves/surfaces/volumes).
    - [X] Ensure mesh preview updates after import.

*** TODO 2. Geometry Primitives & Transforms
    - [X] Add primitives: Box / Cylinder / Sphere.
    - [X] Add transforms: Translate / Rotate / Scale (by IDs or selection list).
    - [X] Add boolean ops: Fuse / Cut / Intersect for volumes.
    - [X] Show entity list per dimension in UI (IDs + names).

*** TODO 3. Physical Groups Management
    - [X] List all physical groups by dimension.
    - [X] Create / rename / delete physical groups.
    - [X] Assign entities to groups (by selection list).
    - [X] Sync group names to MOOSE BC list.

*** TODO 4. Mesh Size Controls
    - [X] Global mesh size + per-entity size.
    - [X] Distance/Threshold field support (basic local refinement).
    - [X] Field list UI (create, edit, enable as background).

*** TODO 5. Mesh Algorithms & Options
    - [X] 2D/3D algorithm selection.
    - [X] Recombine options (quad/hex).
    - [X] Optimization level + smoothing.
    - [X] Element order, high-order optimization.

*** TODO 6. Mesh Inspection & Reporting
    - [X] Entity + element counts by physical group.
    - [X] Physical group stats table (dim/tag/name/entity/element).
    - [X] Quality stats (min/mean/max).
    - [X] Visual toggles: edges, faces, volume shell.
    - [X] Mesh viewer group filter (sync from Gmsh panel).
    - [X] Mesh viewer element-type filter + opacity/shrink.
    - [X] Mesh pick inspector (cell/group/type/quality).
    - [X] Mesh pick highlight (group/cell) with overlay.
    - [X] View controls (axes/outline/camera presets).
    - [X] Entity-level picking + filter, and pick-to-entity fill.

*** TODO 7. Import/Export Round-Trip
    - [X] Save mesh (.msh).
    - [X] Export geometry (BREP / GEO_UNROLLED).
    - [X] Persist gmsh config in project YAML.

** Execution Checklist (Detailed)
   - [X] Add GmshPanel “Open Geometry” + filters.
   - [X] Implement gmsh::model::occ::importShapes + gmsh::open fallback.
   - [X] Add “Reset Model” button + log update.
   - [X] Add entity summary panel (counts + IDs).
   - [X] Wire import to mesh preview.
   - [X] Add primitives (box/cylinder/sphere) with parameter UI.
   - [X] Add transforms (translate/rotate/scale).
   - [X] Add boolean ops for volumes.
   - [X] Add Physical Group CRUD UI.
   - [X] Add size fields UI (global + distance/threshold).
   - [X] Add mesh algo controls + recombine/optimize settings.
   - [X] Add mesh report + quality stats in log panel.
   - [X] Add geometry/mesh export.
   - [X] Persist gmsh settings in project YAML.

** Progress Update (2026-02-21)
   - Gmsh: Physical group stats table with entity/element counts.
   - Viewer: Physical group selection now drives mesh group filtering.
   - Project: Gmsh settings persist in project YAML.
   - Gmsh: Element order + high-order optimization controls.
   - Viewer: Added element type filter, shrink/opacity controls, and pick inspector.
   - BC sync: boundary groups now follow dim-1 for 3D/2D/1D meshes.
   - Viewer: Added pick highlight overlay and view controls (axes/outline/presets).
   - Viewer: Added entity pick/filter and view-to-Gmsh entity fill.
   - Project: Persisted MOOSE and Viewer settings into YAML for troubleshooting.
   - UI: Added Model Tree action strip (Add/Duplicate/Rename/Remove).
   - UI: Added project path + dirty status in title/status bar.
   - UI: Added Recent Projects menu + Export Debug Bundle.

* Next Development Plan (UI-First, Post-Gmsh)
** Goal
   - Make the app feel like a complete simulation suite with robust job control and results exploration.
   - UI changes are explicit and prioritized.

** Module Tab Completion (Current Gaps)
   - [ ] Make top module tabs functionally complete (currently Part/Assembly/Step/Interaction/Load/Visualization/Results are still partial or placeholder-driven).
   - [ ] Add module-specific right-pane pages:
     - [ ] Part: dedicated creation/selection page and part metadata quick actions.
     - [ ] Property: keep binding and expose module-sensitive helpers (copy/paste/templates/validation).
     - [ ] Assembly: groups, instance naming, visibility and transforms integration.
     - [ ] Step: step execution settings, output hooks, and sequencing preview.
     - [ ] Interaction: interaction/constraint registry and editing actions.
     - [ ] Load: load presets, bulk creation, and reuse by group.
     - [ ] Visualization: currently mapped to existing VTK result tabs; remove/replace any dead placeholder surfaces.
     - [ ] Results: output dataset selector + quick open of `.e`/`csv`/`txt` summaries.
     - [X] Map all module tabs in `MainWindow` explicitly (remove generic fallback behavior).
   - [ ] Replace center tab placeholders (`Plot view` / `Table view`) with functional content pages and link to result outputs.

** Phase 1: Project + Session UX
   - UI: Add project path + dirty indicator in window title and status bar.
   - UI: Add File menu items: Recent Projects, Export Debug Bundle.
   - UI: Add toolbar buttons: Save, Save As, Open Project.
   - Data: Extend project metadata (version, saved_at, app_version).

** Phase 2: Model Tree + Property Panel Revamp
   - [X] UI: Add top action strip above Model Tree (Add, Duplicate, Remove, Rename).
   - [X] UI: Inline rename and context menu per node type.
   - [X] UI: Property panel header shows active item name, type, and status.
   - [X] UI: Split Property panel into tabs (General, Parameters, Preview).
   - [X] Data: Normalize params schema per node kind.

** Phase 3: Physics Authoring (MOOSE Mapping)
   - [~] UI: New forms for Materials, Sections, Steps, BC, Loads with validation.
   - [X] UI: BC/Load panel shows physical groups with multi-select.
   - [~] UI: Add “Apply to Group(s)” actions and summary chips.
   - [X] Data: Deterministic block mapping from model tree to MOOSE input.

** Phase 4: Job Manager
   - [X] UI: Job list table (Name, Status, Start, Duration, Mesh, Exec, Result).
   - [X] UI: Run controls (Run, Stop, Retry, Open Log, Open Result).
   - [X] UI: Job detail drawer with full command, environment, and log tail.
   - [X] Data: Persist job history and last run metadata in project.

** Phase 5: Results + Visualization
   - [X] UI: Dedicated Visualization module layout:
     Viewport + Left panel (variables) + Right panel (display controls).
   - [X] UI: Add tabs for Scalar, Vector, Deformation, Slice, Probe, Plot, Table.
   - [X] UI: Add probe tool and selection readout (node/cell/value).
   - [X] UI: Add vector stats/auto-sync and deformation linkage from array picker.
   - [X] UI: Add plot/table result views with refresh, sorting-ready tabs and row controls.
   - [X] Data: Save last used result variables and display settings.

** Phase 6: Diagnostics + Supportability
   - UI: Diagnostics tab with environment checks (gmsh/moose/paraview, VTK).
   - UI: “Export Debug Bundle” dialog (project + mesh + logs + inputs).
   - Data: Write diagnostics report into bundle.

** Phase 7: Preferences + Cross-Platform
   - UI: Preferences dialog (Paths, Runtime, Performance, UI).
   - UI: Auto-detect paths, allow overrides, show status.
   - Data: Persist user preferences separately from project.

** Progress Update (2026-02-22)
   - Model Tree: Context menu now aligns with action strip (Add/Duplicate/Rename/Remove).
   - Property Panel: Added Status field and kept tabs for General/Parameters/Preview.
   - Property Panel: Added BC/Load group selection + lightweight validation.
   - Property Panel: Added quick-parameter forms for core physics nodes.
   - Property Panel: Added type-aware visibility, stricter validation, and advanced param toggle.
   - Property Panel: Added template presets + type template apply.
   - Validation Summary: persistent side panel with node navigation.
   - Visualization: Controls reorganized into tabs with placeholders for Vector/Deformation/Probe/Plot/Table.
   - Visualization: Added left panel array list + filter.
   - Visualization: Added probe tool (point/cell) with readout.
   - Visualization: Added deformation controls + warp pipeline.
   - Visualization: Persisted probe/deformation settings into project.
   - Visualization: Added vector tab stats and auto-sync to deformation vector control.
   - Visualization: Added plot/table data preview and adjustable row count, with persisted settings.
   - VTK: Plot/Table/Vector panes now refresh automatically on time/array/file updates.
   - Job Manager: Added job history table, controls, and detail panel.
   - UI polish: Fixed QComboBox popup width/position and hover rendering issues in toolbars/property panels to keep dropdowns usable.
   - UI layout/UX: Reduced default main window height footprint and vertical panel minima; dropdowns now reserve room for arrow marker and keep 2D/3D form entries more compact for single-screen fitting.
** Progress Update (2026-02-24)
   - Main window: reduced startup height and tightened global content spacing to improve single-screen fit.
   - Dropdown UX: restored explicit down-arrow rendering and adjusted popup placement/sizing.
   - Popup now uses content-aware width calculation and opens below the editor, with width constrained to available screen space.
   - Added deferred geometry recalculation + retry logic (`show/resize/move`) for stable first-frame placement.
   - Improved combo item visibility by disabling text elision and expanding popup min width.
   - Added inline down-arrow glyph in stylesheet for consistent arrow visibility across platforms.
   - Lowered minima (`Plot`/`Table`/`VTK`/`Console`/Job table) to reduce vertical overflow on smaller displays.
   - Gmsh panel: aligned entity/dimension combo boxes with shared popup fixer (position clamp below control and full item width).
   - Gmsh panel: tuned combo sizing to keep arrow area visible on compact rows.
   - Gmsh panel: applied popup width fixes to physical group/mesh/primitive controls to avoid clipped entries.
** Progress Update (2026-02-24)
   - UI polish pass for open issues:
     1) 强制下拉箭头使用可兼容形状渲染（避免无图标平台失效）。
     2) 强化 `QComboBox` 弹出列表的重排触发：`Show/ShowToParent/Move/Resize/Mouse/FoucsIn`，并强制设置弹窗在输入框下沿展开。
     3) 增强弹窗宽度策略：按最长条目重算并固定可见宽度，避免只看到短内容；启用水平滚动条不截断文本。
     4) 进一步降低中部视口/面板默认最小高度与主窗口初始高度，避免窗口整体偏高导致单屏无法完整显示。
** Progress Update (2026-02-24)
   - 下拉箭头修复：更新为正确的 inline SVG glyph，恢复所有平台的箭头可见性。
   - 弹窗高度修复：为 `QComboBox` 弹出列表添加基于行高/行数的最小高度保护，避免“几像素”级高度塌陷（单项看不到完整列表）。
   - 生成后续建议：请复测 `Gmsh`/`VTK` 与 `Property` 区域内每个下拉框的箭头与下拉项高度是否恢复正常；仍异常可按 combo 名称补充针对性修复。

** Progress Update (2026-02-24)
   - 统一抽象 `QComboBox` 下拉框修复逻辑为共享工具 (`ComboPopupFix`)，并接入 `Property` 与 `MOOSE` 模块动态生成下拉框；
   - `Property` 面板与 `MOOSE` 面板的下拉框已统一安装弹窗修复钩子，优先确保下拉箭头可见、弹出位置在输入框下沿且可见项高度不少于几行；
   - 仍建议对 `Gmsh`/`VTK` 自有实现继续保持回归验证，特别是 `Transform` 维度下拉与网格参数下拉。 
** Progress Update (2026-02-24)
   - 模块页切换修复：修正顶部模块标签到右侧页签的映射（`Visualization` 正确映射到结果页签 `8`，避免仍停留在 Job 页）。
   - 图表/表格入口修复：Plot/Plot helper 与 Table 的跳转按钮改为各自目标页（`table_open` 直接切到 `Table` 页面）。
** Progress Update (2026-02-24)
   - 下拉修复收敛：`GmshPanel` 和 `VtkViewer` 移除各自的重复实现，统一复用 `ComboPopupFix`（箭头显示、下沿弹出、内容宽度与最小高度逻辑集中在共享实现）。
   - 回归：已完成全量构建（`cmake --build build -j4`）并通过，`GmshPanel`/`VTK` 下拉现在走同一套弹窗修复流程。
